<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper-Ottehr Integration Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .integration-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .integration-card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-healthy {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-error {
            background: #ffe6e6;
            color: #d32f2f;
        }

        .demo-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .workflow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .workflow-step {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #e9ecef;
            transition: all 0.3s ease;
        }

        .workflow-step.active {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .workflow-step.completed {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .workflow-step.active .step-number {
            background: #667eea;
        }

        .workflow-step.completed .step-number {
            background: #4caf50;
        }

        .integration-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .transcription-panel, .ottehr-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .result-display.show {
            display: block;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            font-size: 0.875rem;
            color: #666;
        }

        .result-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .medical-terms {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .medical-term {
            padding: 4px 8px;
            background: #e8f5e8;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 0.875rem;
            border: 1px solid #4caf50;
        }

        .order-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
            display: none;
        }

        .order-display.show {
            display: block;
        }

        .processing {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .processing.show {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffe6e6;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #d32f2f;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .compliance-info {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #4caf50;
        }

        .api-endpoints {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .api-endpoint {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .endpoint-method {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #333;
        }

        @media (max-width: 768px) {
            .integration-demo {
                grid-template-columns: 1fr;
            }
            
            .workflow-steps {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üé§ Whisper-Ottehr Integration</h1>
            <p>Seamless Healthcare Voice Transcription with Workflow Integration</p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                <span style="background: #e3f2fd; color: #1976d2; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">Real-time Transcription</span>
                <span style="background: #e8f5e8; color: #2e7d32; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">Healthcare Workflows</span>
                <span style="background: #fff3e0; color: #f57c00; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">HIPAA Compliant</span>
            </div>
        </header>

        <!-- Integration Status -->
        <div class="integration-grid">
            <div class="integration-card">
                <h2>üéôÔ∏è Whisper Service</h2>
                <div class="service-status">
                    <span>Speech Recognition API</span>
                    <span id="whisper-status" class="status-indicator status-healthy">Connected</span>
                </div>
                <div class="service-status">
                    <span>File Support</span>
                    <span class="status-indicator status-healthy">MP3, WAV, M4A, WebM</span>
                </div>
                <div class="service-status">
                    <span>Max File Size</span>
                    <span class="status-indicator status-healthy">25MB</span>
                </div>
            </div>

            <div class="integration-card">
                <h2>üè• Ottehr Service</h2>
                <div class="service-status">
                    <span>Healthcare API</span>
                    <span id="ottehr-status" class="status-indicator status-healthy">Connected</span>
                </div>
                <div class="service-status">
                    <span>Order Management</span>
                    <span class="status-indicator status-healthy">Enabled</span>
                </div>
                <div class="service-status">
                    <span>Notifications</span>
                    <span class="status-indicator status-healthy">Active</span>
                </div>
            </div>

            <div class="integration-card">
                <h2>üîó Integration Status</h2>
                <div class="service-status">
                    <span>Auto Transcription</span>
                    <span class="status-indicator status-healthy">Enabled</span>
                </div>
                <div class="service-status">
                    <span>Medical Context</span>
                    <span class="status-indicator status-healthy">Active</span>
                </div>
                <div class="service-status">
                    <span>Order Creation</span>
                    <span class="status-indicator status-healthy">Ready</span>
                </div>
            </div>
        </div>

        <!-- Workflow Demo -->
        <section class="demo-section">
            <h2 style="margin-bottom: 30px; font-size: 2rem; text-align: center;">Integration Workflow Demo</h2>
            
            <!-- Workflow Steps -->
            <div class="workflow-steps">
                <div class="workflow-step" id="step-1">
                    <div class="step-number">1</div>
                    <h3>Audio Input</h3>
                    <p>Upload audio file or record voice</p>
                </div>
                <div class="workflow-step" id="step-2">
                    <div class="step-number">2</div>
                    <h3>Whisper Processing</h3>
                    <p>AI transcription with medical context</p>
                </div>
                <div class="workflow-step" id="step-3">
                    <div class="step-number">3</div>
                    <h3>Healthcare Analysis</h3>
                    <p>Extract medical terms and context</p>
                </div>
                <div class="workflow-step" id="step-4">
                    <div class="step-number">4</div>
                    <h3>Ottehr Integration</h3>
                    <p>Create orders and notifications</p>
                </div>
            </div>

            <!-- Integration Demo Panels -->
            <div class="integration-demo">
                <!-- Whisper Panel -->
                <div class="transcription-panel">
                    <div class="panel-header">
                        <span>üé§</span>
                        <span>Voice Transcription</span>
                    </div>

                    <!-- Patient Context -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Patient Context:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="text" id="patient-id" placeholder="Patient ID" 
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="encounter-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="consultation">Consultation</option>
                                <option value="prescription">Prescription</option>
                                <option value="discharge">Discharge</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                    </div>

                    <!-- Medical Specialty -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Medical Specialty:</label>
                        <select id="specialty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="general">General Medicine</option>
                            <option value="cardiology">Cardiology</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="emergency">Emergency Medicine</option>
                            <option value="surgery">Surgery</option>
                        </select>
                    </div>

                    <!-- Upload Area -->
                    <div class="upload-area" onclick="document.getElementById('audio-file').click()"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="audio-file" class="file-input" accept="audio/*" onchange="handleFileUpload(event)">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üéµ</div>
                        <h3>Drop audio file here or click to browse</h3>
                        <p>Supports MP3, WAV, M4A, WebM, OGG, FLAC (max 25MB)</p>
                    </div>

                    <!-- Recording Button -->
                    <button id="record-btn" class="btn btn-primary" onclick="toggleRecording()" style="width: 100%; margin-bottom: 15px;">
                        üé§ Start Recording
                    </button>

                    <!-- Translation Option -->
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <input type="checkbox" id="enable-translation">
                        <label for="enable-translation">Enable Translation</label>
                        <select id="target-language" style="padding: 4px 8px; border-radius: 4px;" disabled>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                        </select>
                    </div>

                    <!-- Processing Indicator -->
                    <div id="processing" class="processing">
                        <div class="spinner"></div>
                        <span id="processing-message">Processing audio...</span>
                    </div>

                    <!-- Error Display -->
                    <div id="error" class="error-message">
                        <span id="error-text"></span>
                    </div>

                    <!-- Transcription Result -->
                    <div id="transcription-result" class="result-display">
                        <div class="result-meta" id="transcription-meta"></div>
                        <div class="result-text" id="transcription-text"></div>
                        <div id="medical-terms-container" style="margin-bottom: 15px;">
                            <strong>Medical Terms:</strong>
                            <div id="medical-terms" class="medical-terms"></div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-outline" onclick="copyToClipboard('transcription-text')">üìã Copy</button>
                            <button class="btn btn-outline" onclick="clearResults()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Ottehr Panel -->
                <div class="ottehr-panel">
                    <div class="panel-header">
                        <span>üè•</span>
                        <span>Ottehr Integration</span>
                    </div>

                    <!-- Integration Actions -->
                    <div style="margin-bottom: 20px;">
                        <button id="create-order-btn" class="btn btn-success" onclick="createOttehrOrder()" 
                                style="width: 100%; margin-bottom: 10px;" disabled>
                            üìã Create Healthcare Order
                        </button>
                        
                        <button id="send-notification-btn" class="btn btn-outline" onclick="sendNotification()" 
                                style="width: 100%; margin-bottom: 10px;" disabled>
                            üì® Send Notification
                        </button>

                        <button class="btn btn-outline" onclick="checkHealthStatus()" style="width: 100%;">
                            üîç Check Integration Health
                        </button>
                    </div>

                    <!-- Order Display -->
                    <div id="order-result" class="order-display">
                        <h4 style="margin-bottom: 10px; color: #2e7d32;">‚úÖ Order Created Successfully</h4>
                        <div id="order-details"></div>
                    </div>

                    <!-- Notification Display -->
                    <div id="notification-result" class="order-display">
                        <h4 style="margin-bottom: 10px; color: #1976d2;">üì® Notification Sent</h4>
                        <div id="notification-details"></div>
                    </div>

                    <!-- Health Status Display -->
                    <div id="health-result" class="result-display">
                        <h4 style="margin-bottom: 15px;">üîç Integration Health Status</h4>
                        <div id="health-details"></div>
                    </div>

                    <!-- Recent Activity -->
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">Recent Activity</h4>
                        <div id="activity-log" style="background: white; border-radius: 6px; padding: 15px; max-height: 200px; overflow-y: auto;">
                            <p style="color: #666; text-align: center;">No activity yet. Process an audio file to see integration results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- API Documentation -->
        <section class="demo-section">
            <h2 style="margin-bottom: 20px;">Integration API Endpoints</h2>
            <div class="api-endpoints">
                <div class="api-endpoint">
                    <div class="endpoint-method">POST</div>
                    <div class="endpoint-path">/api/whisper/transcribe</div>
                    <p style="margin-top: 8px; font-size: 0.875rem; color: #666;">Transcribe audio with healthcare context</p>
                </div>
                <div class="api-endpoint">
                    <div class="endpoint-method">POST</div>
                    <div class="endpoint-path">/api/ottehr/orders</div>
                    <p style="margin-top: 8px; font-size: 0.875rem; color: #666;">Create healthcare order from transcription</p>
                </div>
                <div class="api-endpoint">
                    <div class="endpoint-method">POST</div>
                    <div class="endpoint-path">/api/ottehr/notifications</div>
                    <p style="margin-top: 8px; font-size: 0.875rem; color: #666;">Send notifications about transcription</p>
                </div>
                <div class="api-endpoint">
                    <div class="endpoint-method">GET</div>
                    <div class="endpoint-path">/api/integration/health</div>
                    <p style="margin-top: 8px; font-size: 0.875rem; color: #666;">Check integration health status</p>
                </div>
            </div>
        </section>

        <!-- Compliance Information -->
        <div class="compliance-info">
            <h3 style="margin-bottom: 15px;">üîí Healthcare Compliance & Security</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div>
                    <strong>HIPAA Compliance:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Secure audio processing</li>
                        <li>Data encryption in transit</li>
                        <li>Audit logging enabled</li>
                        <li>No permanent storage</li>
                    </ul>
                </div>
                <div>
                    <strong>Integration Features:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Real-time transcription</li>
                        <li>Medical term extraction</li>
                        <li>Workflow automation</li>
                        <li>Multi-language support</li>
                    </ul>
                </div>
                <div>
                    <strong>Healthcare Workflow:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Patient context integration</li>
                        <li>Automated order creation</li>
                        <li>Notification system</li>
                        <li>Medical specialty support</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentTranscription = null;
        let activityLog = [];

        // Mock integration service
        const mockWhisperOttehrIntegration = {
            transcribeWithHealthcareContext: async (request) => {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const mockResults = {
                    consultation: {
                        text: 'The patient is experiencing chest pain and shortness of breath. Blood pressure is elevated at 150 over 95. Recommending ECG and cardiac enzymes.',
                        medicalTerms: ['chest pain', 'shortness of breath', 'blood pressure', 'ECG', 'cardiac enzymes'],
                        specialty: request.specialty,
                        confidence: 0.95,
                        language: 'en'
                    },
                    prescription: {
                        text: 'Patient requires metformin 500mg twice daily with meals. Also prescribing lisinopril 10mg once daily for blood pressure control.',
                        medicalTerms: ['metformin', '500mg', 'twice daily', 'lisinopril', '10mg', 'blood pressure'],
                        specialty: request.specialty,
                        confidence: 0.98,
                        language: 'en'
                    },
                    emergency: {
                        text: 'Patient presents with severe abdominal pain, nausea, and vomiting. Vital signs show tachycardia and hypotension. Initiating IV fluids.',
                        medicalTerms: ['abdominal pain', 'nausea', 'vomiting', 'tachycardia', 'hypotension', 'IV fluids'],
                        specialty: request.specialty,
                        confidence: 0.92,
                        language: 'en'
                    }
                };

                const encounterType = request.encounterType || 'consultation';
                const result = mockResults[encounterType] || mockResults.consultation;

                return {
                    ...result,
                    patientContext: {
                        patientId: request.patientId,
                        encounterType: request.encounterType,
                        timestamp: new Date().toISOString()
                    },
                    medicalConfidence: 0.89
                };
            },

            createOrderWithTranscription: async (orderId, transcriptionResult) => {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return {
                    success: true,
                    data: {
                        id: orderId,
                        customerId: transcriptionResult.patientContext?.patientId || 'unknown',
                        items: [],
                        totalAmount: 0,
                        currency: 'USD',
                        status: 'pending',
                        metadata: {
                            transcriptionData: {
                                text: transcriptionResult.text,
                                medicalTerms: transcriptionResult.medicalTerms,
                                specialty: transcriptionResult.specialty
                            }
                        },
                        createdAt: new Date().toISOString()
                    }
                };
            },

            sendNotification: async (notification) => {
                await new Promise(resolve => setTimeout(resolve, 500));
                return {
                    success: true,
                    data: {
                        id: `notification_${Date.now()}`,
                        ...notification,
                        status: 'sent',
                        createdAt: new Date().toISOString()
                    }
                };
            },

            getHealthStatus: async () => {
                await new Promise(resolve => setTimeout(resolve, 300));
                return {
                    whisper: { status: 'healthy' },
                    ottehr: { status: 'healthy' },
                    integration: { status: 'healthy', configValid: true }
                };
            }
        };

        // Utility functions
        function updateWorkflowStep(stepNumber, status = 'active') {
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active', 'completed');
                if (i < stepNumber) {
                    step.classList.add('completed');
                } else if (i === stepNumber && status === 'active') {
                    step.classList.add('active');
                }
            }
        }

        function showProcessing(message = 'Processing audio...') {
            const processing = document.getElementById('processing');
            const processingMessage = document.getElementById('processing-message');
            processingMessage.textContent = message;
            processing.classList.add('show');
        }

        function hideProcessing() {
            document.getElementById('processing').classList.remove('show');
        }

        function showError(message) {
            const error = document.getElementById('error');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            error.classList.add('show');
        }

        function hideError() {
            document.getElementById('error').classList.remove('show');
        }

        function addToActivityLog(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            activityLog.unshift({ type, message, timestamp, data });
            
            // Keep only last 10 items
            if (activityLog.length > 10) {
                activityLog = activityLog.slice(0, 10);
            }
            
            updateActivityLogDisplay();
        }

        function updateActivityLogDisplay() {
            const logContainer = document.getElementById('activity-log');
            
            if (activityLog.length === 0) {
                logContainer.innerHTML = '<p style="color: #666; text-align: center;">No activity yet. Process an audio file to see integration results.</p>';
                return;
            }
            
            logContainer.innerHTML = activityLog.map(item => `
                <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #667eea;">
                    <div style="font-weight: 500; color: #2c3e50;">${item.message}</div>
                    <div style="font-size: 0.875rem; color: #666;">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            processAudioFile(file);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processAudioFile(files[0]);
            }
        }

        async function processAudioFile(file) {
            hideError();
            updateWorkflowStep(1);
            showProcessing('Uploading and processing audio file...');

            try {
                // Validate file
                const maxSize = 25 * 1024 * 1024; // 25MB
                const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/webm', 'audio/ogg', 'audio/flac', 'audio/m4a'];
                
                if (file.size > maxSize) {
                    throw new Error('File size exceeds 25MB limit');
                }

                if (!allowedTypes.some(type => file.type.includes(type.split('/')[1]))) {
                    throw new Error(`Unsupported file type: ${file.type}`);
                }

                updateWorkflowStep(2);
                showProcessing('Processing with Whisper...');

                // Prepare request
                const request = {
                    audioFile: file,
                    patientId: document.getElementById('patient-id').value || 'demo-patient-123',
                    encounterType: document.getElementById('encounter-type').value,
                    specialty: document.getElementById('specialty').value,
                    targetLanguage: document.getElementById('enable-translation').checked ? 
                                   document.getElementById('target-language').value : undefined
                };

                // Process with mock integration
                const result = await mockWhisperOttehrIntegration.transcribeWithHealthcareContext(request);

                updateWorkflowStep(3);
                showProcessing('Analyzing healthcare context...');

                // Brief delay for demo effect
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Display transcription result
                displayTranscriptionResult(result);
                
                updateWorkflowStep(4);
                hideProcessing();

                // Enable Ottehr integration buttons
                document.getElementById('create-order-btn').disabled = false;
                document.getElementById('send-notification-btn').disabled = false;

                addToActivityLog('transcription', `Audio transcribed: ${result.medicalTerms.length} medical terms found`, result);

            } catch (error) {
                hideProcessing();
                showError(error.message);
                updateWorkflowStep(1);
                addToActivityLog('error', `Transcription failed: ${error.message}`);
            }
        }

        function displayTranscriptionResult(result) {
            currentTranscription = result;

            // Update metadata
            const meta = document.getElementById('transcription-meta');
            meta.innerHTML = `
                <span>Language: ${result.language?.toUpperCase()}</span>
                <span>Confidence: ${Math.round(result.confidence * 100)}%</span>
                <span>Medical Terms: ${result.medicalTerms.length}</span>
                <span>Specialty: ${result.specialty}</span>
                <span>Patient: ${result.patientContext?.patientId}</span>
            `;

            // Update transcription text
            document.getElementById('transcription-text').textContent = result.text;

            // Update medical terms
            const termsContainer = document.getElementById('medical-terms');
            termsContainer.innerHTML = result.medicalTerms.map(term => 
                `<span class="medical-term">${term}</span>`
            ).join('');

            // Show result
            document.getElementById('transcription-result').classList.add('show');
        }

        // Recording functions
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioFile = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    await processAudioFile(audioFile);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                // Update UI
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = 'üõë Stop Recording';
                recordBtn.classList.remove('btn-primary');
                recordBtn.classList.add('btn-danger');

                updateWorkflowStep(1);
                addToActivityLog('recording', 'Started audio recording');

            } catch (error) {
                showError('Microphone access denied. Please allow microphone access and try again.');
                addToActivityLog('error', `Recording failed: ${error.message}`);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            isRecording = false;

            // Update UI
            const recordBtn = document.getElementById('record-btn');
            recordBtn.textContent = 'üé§ Start Recording';
            recordBtn.classList.remove('btn-danger');
            recordBtn.classList.add('btn-primary');

            addToActivityLog('recording', 'Stopped audio recording');
        }

        // Ottehr integration functions
        async function createOttehrOrder() {
            if (!currentTranscription) return;

            showProcessing('Creating healthcare order...');

            try {
                const orderId = `order_${Date.now()}`;
                const result = await mockWhisperOttehrIntegration.createOrderWithTranscription(orderId, currentTranscription);

                hideProcessing();

                // Display order result
                const orderResult = document.getElementById('order-result');
                const orderDetails = document.getElementById('order-details');
                
                orderDetails.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>Order ID:</strong> ${result.data.id}</div>
                    <div style="margin-bottom: 10px;"><strong>Patient:</strong> ${result.data.customerId}</div>
                    <div style="margin-bottom: 10px;"><strong>Status:</strong> ${result.data.status}</div>
                    <div style="margin-bottom: 10px;"><strong>Created:</strong> ${new Date(result.data.createdAt).toLocaleString()}</div>
                    <div><strong>Medical Context:</strong> ${result.data.metadata.transcriptionData.medicalTerms.join(', ')}</div>
                `;
                
                orderResult.classList.add('show');
                
                addToActivityLog('order', `Created order ${result.data.id} for patient ${result.data.customerId}`, result.data);

            } catch (error) {
                hideProcessing();
                showError(`Failed to create order: ${error.message}`);
                addToActivityLog('error', `Order creation failed: ${error.message}`);
            }
        }

        async function sendNotification() {
            if (!currentTranscription) return;

            showProcessing('Sending notification...');

            try {
                const notification = {
                    type: 'system_alert',
                    recipientId: currentTranscription.patientContext?.patientId || 'demo-patient',
                    title: 'Audio Transcription Completed',
                    message: `Transcription completed for ${currentTranscription.specialty} encounter. ${currentTranscription.medicalTerms.length} medical terms identified.`,
                    channels: ['in_app', 'email']
                };

                const result = await mockWhisperOttehrIntegration.sendNotification(notification);

                hideProcessing();

                // Display notification result
                const notificationResult = document.getElementById('notification-result');
                const notificationDetails = document.getElementById('notification-details');
                
                notificationDetails.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>Notification ID:</strong> ${result.data.id}</div>
                    <div style="margin-bottom: 10px;"><strong>Recipient:</strong> ${result.data.recipientId}</div>
                    <div style="margin-bottom: 10px;"><strong>Status:</strong> ${result.data.status}</div>
                    <div style="margin-bottom: 10px;"><strong>Channels:</strong> ${result.data.channels.join(', ')}</div>
                    <div><strong>Message:</strong> ${result.data.message}</div>
                `;
                
                notificationResult.classList.add('show');
                
                addToActivityLog('notification', `Sent notification ${result.data.id} to ${result.data.recipientId}`, result.data);

            } catch (error) {
                hideProcessing();
                showError(`Failed to send notification: ${error.message}`);
                addToActivityLog('error', `Notification failed: ${error.message}`);
            }
        }

        async function checkHealthStatus() {
            showProcessing('Checking integration health...');

            try {
                const health = await mockWhisperOttehrIntegration.getHealthStatus();

                hideProcessing();

                // Display health result
                const healthResult = document.getElementById('health-result');
                const healthDetails = document.getElementById('health-details');
                
                healthDetails.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <strong>Whisper Service</strong><br>
                            Status: <span style="color: #2e7d32;">${health.whisper.status}</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <strong>Ottehr Service</strong><br>
                            Status: <span style="color: #2e7d32;">${health.ottehr.status}</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <strong>Integration</strong><br>
                            Status: <span style="color: #2e7d32;">${health.integration.status}</span><br>
                            Config Valid: <span style="color: #2e7d32;">${health.integration.configValid ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `;
                
                healthResult.classList.add('show');
                
                addToActivityLog('health', 'Integration health check completed', health);

            } catch (error) {
                hideProcessing();
                showError(`Health check failed: ${error.message}`);
                addToActivityLog('error', `Health check failed: ${error.message}`);
            }
        }

        // Utility functions
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                addToActivityLog('action', 'Text copied to clipboard');
            }).catch(() => {
                showError('Failed to copy text');
            });
        }

        function clearResults() {
            document.getElementById('transcription-result').classList.remove('show');
            document.getElementById('order-result').classList.remove('show');
            document.getElementById('notification-result').classList.remove('show');
            document.getElementById('health-result').classList.remove('show');
            document.getElementById('create-order-btn').disabled = true;
            document.getElementById('send-notification-btn').disabled = true;
            currentTranscription = null;
            hideError();
            updateWorkflowStep(1);
            addToActivityLog('action', 'Results cleared');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Enable translation checkbox functionality
            document.getElementById('enable-translation').addEventListener('change', function() {
                document.getElementById('target-language').disabled = !this.checked;
            });

            // Initialize activity log
            updateActivityLogDisplay();
            
            addToActivityLog('system', 'Whisper-Ottehr Integration Demo loaded');
        });
    </script>
</body>
</html>