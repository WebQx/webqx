<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebQx Whisper Integration Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .feature-card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-card .icon {
            font-size: 2rem;
        }

        .demo-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .demo-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .realtime-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .record-button {
            padding: 20px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .record-button:not(.recording) {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .record-button.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .audio-visualizer {
            display: flex;
            justify-content: center;
            align-items: end;
            height: 100px;
            gap: 3px;
            margin: 20px 0;
        }

        .audio-bar {
            width: 4px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .language-selector {
            margin-bottom: 20px;
        }

        .language-selector select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .transcription-result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
        }

        .transcription-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .transcription-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .error-message {
            background: #ffe6e6;
            color: #d32f2f;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #d32f2f;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 5px solid #2196f3;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .compliance-info {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            border-left: 5px solid #4caf50;
        }

        .compliance-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-panel {
            margin-top: 30px;
        }

        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .history-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .realtime-controls {
                flex-direction: column;
            }

            .record-button {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Screen reader announcements -->
    <div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üé§ WebQx Whisper Integration</h1>
            <p>Advanced Speech Recognition for Healthcare Applications</p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <span style="background: #e3f2fd; color: #1976d2; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">HIPAA Compliant</span>
                <span style="background: #e8f5e8; color: #2e7d32; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">Multilingual</span>
                <span style="background: #fff3e0; color: #f57c00; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">Real-time</span>
                <span style="background: #fce4ec; color: #c2185b; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">Accessible</span>
            </div>
        </header>

        <!-- Features Grid -->
        <div class="features-grid">
            <div class="feature-card">
                <h3><span class="icon">üè•</span>Healthcare Optimized</h3>
                <p>Specialized medical vocabulary and terminology recognition for accurate clinical documentation.</p>
            </div>
            <div class="feature-card">
                <h3><span class="icon">üåç</span>Multilingual Support</h3>
                <p>Support for 12+ languages with automatic detection and real-time translation capabilities.</p>
            </div>
            <div class="feature-card">
                <h3><span class="icon">‚ôø</span>Accessibility First</h3>
                <p>Full screen reader support, voice commands, and audio level indicators for users with disabilities.</p>
            </div>
            <div class="feature-card">
                <h3><span class="icon">üîí</span>HIPAA Compliant</h3>
                <p>Secure processing with encryption, audit logging, and healthcare data protection standards.</p>
            </div>
        </div>

        <!-- Demo Section -->
        <section class="demo-section">
            <h2 style="margin-bottom: 30px; font-size: 2rem; text-align: center;">Interactive Demo</h2>
            
            <!-- Demo Tabs -->
            <div class="demo-tabs">
                <button class="tab-button active" onclick="switchTab('file')">üìÅ File Upload</button>
                <button class="tab-button" onclick="switchTab('realtime')">üéôÔ∏è Real-time</button>
                <button class="tab-button" onclick="switchTab('features')">‚öôÔ∏è Advanced Features</button>
            </div>

            <!-- File Upload Tab -->
            <div id="file-tab" class="tab-content active">
                <div class="language-selector">
                    <label for="language-select">Language:</label>
                    <select id="language-select" onchange="updateLanguage()">
                        <option value="auto">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish (Espa√±ol)</option>
                        <option value="fr">French (Fran√ßais)</option>
                        <option value="de">German (Deutsch)</option>
                        <option value="zh">Chinese (‰∏≠Êñá)</option>
                        <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                    </select>
                </div>

                <div class="upload-area" onclick="document.getElementById('file-input').click()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <input type="file" id="file-input" class="file-input" accept="audio/*" onchange="handleFileUpload(event)">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéµ</div>
                    <h3>Drop audio file here or click to browse</h3>
                    <p>Supported formats: MP3, WAV, M4A, WebM, OGG, FLAC (max 25MB)</p>
                </div>
            </div>

            <!-- Real-time Tab -->
            <div id="realtime-tab" class="tab-content">
                <div class="realtime-controls">
                    <button id="record-button" class="record-button" onclick="toggleRecording()">
                        üé§ Start Recording
                    </button>
                    <div class="language-selector">
                        <select id="realtime-language-select">
                            <option value="auto">Auto-detect</option>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                        </select>
                    </div>
                </div>

                <div class="audio-visualizer" id="audio-visualizer" style="display: none;">
                    <!-- Audio bars will be generated dynamically -->
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <div id="recording-status" style="font-size: 1.1rem; color: #666;">
                        Click "Start Recording" to begin real-time transcription
                    </div>
                </div>
            </div>

            <!-- Features Tab -->
            <div id="features-tab" class="tab-content">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <h4>üè• Medical Specialty</h4>
                        <select id="specialty-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e9ecef;">
                            <option value="general">General Medicine</option>
                            <option value="cardiology">Cardiology</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="emergency">Emergency Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <h4>üåê Translation</h4>
                        <label>
                            <input type="checkbox" id="translation-enabled" onchange="toggleTranslation()"> 
                            Enable real-time translation
                        </label>
                        <select id="target-language" style="margin-left: 10px; padding: 5px; border-radius: 5px;" disabled>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                        </select>
                    </div>

                    <div>
                        <h4>‚ôø Accessibility</h4>
                        <label>
                            <input type="checkbox" id="accessibility-enabled" checked onchange="toggleAccessibility()"> 
                            Enable screen reader announcements
                        </label>
                    </div>

                    <div>
                        <h4>üìä Visualization</h4>
                        <label>
                            <input type="checkbox" id="visualization-enabled" onchange="toggleVisualization()"> 
                            Enable audio level visualization
                        </label>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <span id="loading-message">Processing audio...</span>
            </div>

            <!-- Error Message -->
            <div id="error" class="error-message" style="display: none;"></div>

            <!-- Transcription Result -->
            <div id="result" class="transcription-result" style="display: none;">
                <div class="transcription-meta" id="result-meta"></div>
                <div class="transcription-text" id="result-text"></div>
                <div id="translation-result" style="display: none;">
                    <h5>üåê Translation:</h5>
                    <div id="translation-text" style="font-style: italic; margin-top: 10px;"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyToClipboard('result-text')">üìã Copy</button>
                    <button class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Clear</button>
                    <button class="btn btn-secondary" onclick="downloadTranscript()">üíæ Download</button>
                </div>
            </div>
        </section>

        <!-- Transcription History -->
        <section class="demo-section">
            <h3>üìù Transcription History</h3>
            <div id="history" class="history-panel">
                <p style="color: #666; text-align: center; padding: 20px;">No transcriptions yet. Upload a file or start recording to begin.</p>
            </div>
        </section>

        <!-- Compliance Information -->
        <div class="compliance-info">
            <h4>üîí Healthcare Compliance & Security</h4>
            <ul style="margin-left: 20px;">
                <li><strong>HIPAA Compliant:</strong> All audio processing follows healthcare data protection standards</li>
                <li><strong>Secure Processing:</strong> Data encrypted in transit and at rest</li>
                <li><strong>Audit Logging:</strong> Complete activity logs for compliance reporting</li>
                <li><strong>No Data Retention:</strong> Audio files are processed and immediately deleted</li>
                <li><strong>Patient Consent:</strong> Integrated consent management for recording activities</li>
            </ul>
        </div>
    </div>

    <script>
        // Global state
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let transcriptionHistory = [];
        let currentLanguage = 'auto';
        let accessibilityEnabled = true;
        let visualizationEnabled = false;
        let translationEnabled = false;

        // Mock service configurations
        const mockTranscriptions = {
            'hello-world.wav': {
                text: 'Hello, this is a test of the Whisper speech recognition system. The patient is experiencing chest pain and shortness of breath.',
                language: 'en',
                confidence: 0.95,
                duration: 5.2
            },
            'spanish-test.mp3': {
                text: 'Hola, el paciente tiene dolor de cabeza y fiebre desde hace dos d√≠as.',
                language: 'es',
                confidence: 0.92,
                duration: 4.1
            },
            'french-medical.wav': {
                text: 'Le patient pr√©sente des sympt√¥mes de grippe avec une temp√©rature √©lev√©e.',
                language: 'fr',
                confidence: 0.89,
                duration: 3.8
            }
        };

        const translations = {
            'en-es': {
                'Hello, this is a test of the Whisper speech recognition system. The patient is experiencing chest pain and shortness of breath.': 'Hola, esta es una prueba del sistema de reconocimiento de voz Whisper. El paciente est√° experimentando dolor en el pecho y falta de aire.'
            },
            'es-en': {
                'Hola, el paciente tiene dolor de cabeza y fiebre desde hace dos d√≠as.': 'Hello, the patient has had a headache and fever for two days.'
            },
            'fr-en': {
                'Le patient pr√©sente des sympt√¥mes de grippe avec une temp√©rature √©lev√©e.': 'The patient presents flu symptoms with high temperature.'
            }
        };

        // Utility functions
        function announceToScreenReader(message) {
            if (!accessibilityEnabled) return;
            const announcements = document.getElementById('announcements');
            announcements.textContent = message;
        }

        function showLoading(message = 'Processing audio...') {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-message').textContent = message;
            announceToScreenReader(message);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            announceToScreenReader(`Error: ${message}`);
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            announceToScreenReader(`Switched to ${tabName} tab`);
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            hideError();
            processAudioFile(file);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processAudioFile(files[0]);
            }
        }

        async function processAudioFile(file) {
            // Validate file
            const maxSize = 25 * 1024 * 1024; // 25MB
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/webm', 'audio/ogg', 'audio/flac', 'audio/m4a'];
            
            if (file.size > maxSize) {
                showError('File size exceeds 25MB limit');
                return;
            }

            if (!allowedTypes.includes(file.type)) {
                showError(`Unsupported file type: ${file.type}`);
                return;
            }

            showLoading('Uploading and processing audio file...');

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Mock transcription based on filename
                const mockKey = Object.keys(mockTranscriptions).find(key => 
                    file.name.toLowerCase().includes(key.split('.')[0].split('-')[0])
                ) || 'hello-world.wav';

                const result = mockTranscriptions[mockKey];
                
                // Simulate language detection if auto
                const detectedLanguage = currentLanguage === 'auto' ? result.language : currentLanguage;
                
                displayTranscriptionResult({
                    ...result,
                    language: detectedLanguage,
                    filename: file.name,
                    type: 'file'
                });

                hideLoading();
                announceToScreenReader(`Transcription completed. Detected language: ${getLanguageName(detectedLanguage)}`);

            } catch (error) {
                hideLoading();
                showError('Failed to process audio file. Please try again.');
            }
        }

        // Real-time recording
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processRealTimeAudio(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;

                // Update UI
                const recordButton = document.getElementById('record-button');
                recordButton.classList.add('recording');
                recordButton.textContent = 'üõë Stop Recording';
                
                document.getElementById('recording-status').textContent = 'Recording... Speak now';
                
                if (visualizationEnabled) {
                    startAudioVisualization(stream);
                }

                announceToScreenReader('Recording started. Speak now.');

            } catch (error) {
                showError('Microphone access denied. Please allow microphone access and try again.');
                console.error('Error accessing microphone:', error);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            isRecording = false;

            // Update UI
            const recordButton = document.getElementById('record-button');
            recordButton.classList.remove('recording');
            recordButton.textContent = 'üé§ Start Recording';
            
            document.getElementById('recording-status').textContent = 'Processing recording...';
            
            if (visualizationEnabled) {
                stopAudioVisualization();
            }

            announceToScreenReader('Recording stopped. Processing audio...');
        }

        async function processRealTimeAudio(audioBlob) {
            showLoading('Transcribing real-time audio...');

            try {
                // Simulate processing delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Mock real-time transcription
                const realtimeTexts = [
                    'The patient reports experiencing intermittent chest pain over the past week.',
                    'Vital signs are stable with blood pressure 120 over 80.',
                    'Patient denies any recent changes in medication or lifestyle.',
                    'Recommending ECG and blood work to rule out cardiac issues.'
                ];

                const randomText = realtimeTexts[Math.floor(Math.random() * realtimeTexts.length)];
                const language = document.getElementById('realtime-language-select').value;
                const detectedLanguage = language === 'auto' ? 'en' : language;

                displayTranscriptionResult({
                    text: randomText,
                    language: detectedLanguage,
                    confidence: 0.88 + Math.random() * 0.1,
                    duration: 3.2,
                    type: 'realtime'
                });

                hideLoading();
                document.getElementById('recording-status').textContent = 'Click "Start Recording" to begin real-time transcription';
                announceToScreenReader('Real-time transcription completed');

            } catch (error) {
                hideLoading();
                showError('Failed to process real-time audio');
            }
        }

        // Audio visualization
        function startAudioVisualization(stream) {
            const visualizer = document.getElementById('audio-visualizer');
            visualizer.style.display = 'flex';
            
            // Generate audio bars
            visualizer.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '10px';
                visualizer.appendChild(bar);
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function updateVisualization() {
                if (!isRecording) return;

                analyser.getByteFrequencyData(dataArray);
                const bars = visualizer.querySelectorAll('.audio-bar');
                
                bars.forEach((bar, index) => {
                    const height = Math.max(10, (dataArray[index * 2] / 255) * 100);
                    bar.style.height = height + 'px';
                });

                requestAnimationFrame(updateVisualization);
            }

            updateVisualization();
        }

        function stopAudioVisualization() {
            document.getElementById('audio-visualizer').style.display = 'none';
        }

        // Display results
        function displayTranscriptionResult(result) {
            hideError();
            
            const resultDiv = document.getElementById('result');
            const metaDiv = document.getElementById('result-meta');
            const textDiv = document.getElementById('result-text');
            
            // Update metadata
            metaDiv.innerHTML = `
                <span>Language: ${getLanguageName(result.language)}</span>
                <span>Confidence: ${Math.round(result.confidence * 100)}%</span>
                <span>Duration: ${result.duration?.toFixed(1) || 'N/A'}s</span>
                <span>Type: ${result.type || 'file'}</span>
                <span>Time: ${new Date().toLocaleTimeString()}</span>
            `;
            
            // Update transcription text
            textDiv.textContent = result.text;
            
            // Handle translation
            if (translationEnabled) {
                const targetLang = document.getElementById('target-language').value;
                const translationKey = `${result.language}-${targetLang}`;
                
                if (translations[translationKey] && translations[translationKey][result.text]) {
                    const translationDiv = document.getElementById('translation-result');
                    const translationTextDiv = document.getElementById('translation-text');
                    
                    translationTextDiv.textContent = translations[translationKey][result.text];
                    translationDiv.style.display = 'block';
                } else {
                    document.getElementById('translation-result').style.display = 'none';
                }
            } else {
                document.getElementById('translation-result').style.display = 'none';
            }
            
            resultDiv.style.display = 'block';
            
            // Add to history
            addToHistory(result);
        }

        // History management
        function addToHistory(result) {
            const historyItem = {
                ...result,
                id: Date.now(),
                timestamp: new Date()
            };
            
            transcriptionHistory.unshift(historyItem);
            
            // Keep only last 10 items
            if (transcriptionHistory.length > 10) {
                transcriptionHistory = transcriptionHistory.slice(0, 10);
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('history');
            
            if (transcriptionHistory.length === 0) {
                historyDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No transcriptions yet. Upload a file or start recording to begin.</p>';
                return;
            }
            
            historyDiv.innerHTML = transcriptionHistory.map(item => `
                <div class="history-item">
                    <div class="history-item-header">
                        <span>${item.type === 'file' ? 'üìÅ' : 'üéôÔ∏è'} ${item.type}</span>
                        <span>${getLanguageName(item.language)}</span>
                        <span>${Math.round(item.confidence * 100)}%</span>
                        <span>${item.timestamp.toLocaleTimeString()}</span>
                    </div>
                    <div>${item.text}</div>
                </div>
            `).join('');
        }

        // Utility functions
        function getLanguageName(code) {
            const languages = {
                'en': 'English',
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'zh': 'Chinese',
                'ar': 'Arabic',
                'auto': 'Auto-detect'
            };
            return languages[code] || code;
        }

        function updateLanguage() {
            currentLanguage = document.getElementById('language-select').value;
            announceToScreenReader(`Language changed to ${getLanguageName(currentLanguage)}`);
        }

        function toggleTranslation() {
            translationEnabled = document.getElementById('translation-enabled').checked;
            document.getElementById('target-language').disabled = !translationEnabled;
            announceToScreenReader(`Translation ${translationEnabled ? 'enabled' : 'disabled'}`);
        }

        function toggleAccessibility() {
            accessibilityEnabled = document.getElementById('accessibility-enabled').checked;
            announceToScreenReader(`Accessibility features ${accessibilityEnabled ? 'enabled' : 'disabled'}`);
        }

        function toggleVisualization() {
            visualizationEnabled = document.getElementById('visualization-enabled').checked;
            announceToScreenReader(`Audio visualization ${visualizationEnabled ? 'enabled' : 'disabled'}`);
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                announceToScreenReader('Text copied to clipboard');
                
                // Visual feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(() => {
                announceToScreenReader('Failed to copy text');
            });
        }

        function clearResults() {
            document.getElementById('result').style.display = 'none';
            hideError();
            announceToScreenReader('Results cleared');
        }

        function downloadTranscript() {
            const text = document.getElementById('result-text').textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            announceToScreenReader('Transcript downloaded');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            announceToScreenReader('WebQx Whisper Integration demo loaded. Use tab navigation to explore features.');
            
            // Check for microphone support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Microphone access not supported in this browser. Real-time features unavailable.');
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        document.querySelector('[onclick="switchTab(\'file\')"]').click();
                        break;
                    case '2':
                        event.preventDefault();
                        document.querySelector('[onclick="switchTab(\'realtime\')"]').click();
                        break;
                    case '3':
                        event.preventDefault();
                        document.querySelector('[onclick="switchTab(\'features\')"]').click();
                        break;
                    case 'r':
                        event.preventDefault();
                        if (document.getElementById('realtime-tab').classList.contains('active')) {
                            toggleRecording();
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>